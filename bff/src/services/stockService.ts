import { Stock, StockDetails, StockSearchResult } from '../models/Stock';
import { getStockRepository } from '../utils/database';
import { getYahooFinanceService, YahooFinanceSearchResult } from './yahooFinanceService';

// Helper function to map DB Stock to BFF Stock
const mapDBStockToBFF = (dbStock: any): Stock => ({
  id: dbStock.ISIN,
  symbol: dbStock.SYMBOL,
  isin: dbStock.ISIN,
  name: dbStock.NAME,
  currency: 'USD', // Default since DB doesn't store this
  exchange: 'DEFAULT', // Default since DB doesn't store this
  country: 'US', // Default since DB doesn't store this
  createdAt: new Date(), // Default since DB doesn't store this
  updatedAt: new Date() // Default since DB doesn't store this
});

// Get stock by ISIN
export const getStockByISIN = async (isin: string): Promise<Stock | null> => {
  const stockRepo = getStockRepository();
  const stock = await stockRepo.findByISIN(isin);
  
  if (!stock) {
    return null;
  }

  return mapDBStockToBFF(stock);
};

// Get stock by Symbol
export const getStockBySymbol = async (symbol: string): Promise<Stock | null> => {
  const stockRepo = getStockRepository();
  const stock = await stockRepo.findBySymbol(symbol);
  
  if (!stock) {
    return null;
  }

  return mapDBStockToBFF(stock);
};

// Get stock by WKN
export const getStockByWKN = async (wkn: string): Promise<Stock | null> => {
  const stockRepo = getStockRepository();
  const stock = await stockRepo.findByWKN(wkn);
  
  if (!stock) {
    return null;
  }

  return mapDBStockToBFF(stock);
};

// Get all stocks
export const getAllStocks = async (): Promise<Stock[]> => {
  const stockRepo = getStockRepository();
  const stocks = await stockRepo.findAll();
  return stocks.map(mapDBStockToBFF);
};

// Get stocks by category
export const getStocksByCategory = async (categoryId: string): Promise<Stock[]> => {
  const stockRepo = getStockRepository();
  const stocks = await stockRepo.findByCategory(categoryId);
  return stocks.map(mapDBStockToBFF);
};

// Search stocks using Yahoo Finance
export const searchStocks = async (query: string): Promise<StockSearchResult[]> => {
  const yahooFinance = getYahooFinanceService();
  const results = await yahooFinance.searchStocks(query);
  
  return results.map((result: YahooFinanceSearchResult) => ({
    id: result.symbol, // Using symbol as ID since we don't have ISIN yet
    symbol: result.symbol,
    name: result.name,
    exchange: result.exchange,
    currency: 'USD' // Default since Yahoo Finance API doesn't always provide currency
  }));
};

// Get detailed stock information
export const getStockDetails = async (isin: string): Promise<StockDetails | null> => {
  const stockRepo = getStockRepository();
  const yahooFinance = getYahooFinanceService();

  const stock = await stockRepo.findByISIN(isin);
  if (!stock) {
    return null;
  }

  // Get real-time quote from Yahoo Finance
  try {
    const quote = await yahooFinance.getRealTimeQuote(stock.ISIN);
    
    return {
      ...mapDBStockToBFF(stock),
      currentPrice: quote.price,
      priceChange: quote.price - (quote.open || quote.price), // Fallback to current price if open is not available
      priceChangePercentage: ((quote.price - (quote.open || quote.price)) / (quote.open || quote.price)) * 100,
      volume: quote.volume
    };
  } catch (error) {
    // If Yahoo Finance data is not available, return basic stock info
    return mapDBStockToBFF(stock);
  }
};

// Create a new stock
export const createStock = async (
  categoryId: string,
  stockData: { isin: string; name: string; wkn: string; symbol: string }
): Promise<Stock> => {
  const stockRepo = getStockRepository();
  
  const dbStock = await stockRepo.create({
    ISIN: stockData.isin,
    CATEGORIES_ID: categoryId,
    NAME: stockData.name,
    WKN: stockData.wkn,
    SYMBOL: stockData.symbol
  });

  return mapDBStockToBFF(dbStock);
};

// Update a stock
export const updateStock = async (
  isin: string,
  updateData: Partial<{ name: string; wkn: string; symbol: string; categoryId: string }>
): Promise<Stock | null> => {
  const stockRepo = getStockRepository();
  
  const dbStock = await stockRepo.update(isin, {
    ...(updateData.name && { NAME: updateData.name }),
    ...(updateData.wkn && { WKN: updateData.wkn }),
    ...(updateData.symbol && { SYMBOL: updateData.symbol }),
    ...(updateData.categoryId && { CATEGORIES_ID: updateData.categoryId })
  });

  return mapDBStockToBFF(dbStock);
};

// Delete a stock
export const deleteStock = async (isin: string): Promise<void> => {
  const stockRepo = getStockRepository();
  await stockRepo.delete(isin);
};
